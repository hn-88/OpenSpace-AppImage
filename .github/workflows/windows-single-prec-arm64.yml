name: windows-single-prec-arm64

on: 
  workflow_dispatch:
  #schedule:
  #  - cron: "0 1 * * *"

env:
  BUILD_TYPE: RelWithDebInfo
  OPENSPACE_VERSION: "0.21.3+"
  openSpaceHome: ${{ github.workspace }}/source/OpenSpace
  QT_DIR: C:/Qt/6.9.3/msvc2022_arm64
  QT6_DIR: C:/Qt/6.9.3/msvc2022_arm64
  CMAKE_PREFIX_PATH: C:/Qt/6.9.3/msvc2022_arm64/lib/cmake
  buildConfig: RelWithDebInfo
  
jobs:
  build:
    runs-on: windows-11-arm

    steps:
    - uses: actions/checkout@v4
    
    - name: get openspace code for a particular release
      run: |
        git clone --recursive https://github.com/OpenSpace/OpenSpace $env:openSpaceHome
        cd $env:openSpaceHome
        git checkout "296081379b18da62686d2c0635c2478daae1b68b" --recurse-submodules
        git submodule update --init --recursive
        mkdir build
        cd build
        
    - name: Install QT dependencies
      shell: pwsh
      run: |
        python -m pip install --upgrade pip
        pip install aqtinstall
        aqt install-qt windows desktop 6.9.3 win64_msvc2022_64 --outputdir C:\Qt
        aqt install-qt windows desktop 6.9.3 win64_msvc2022_arm64_cross_compiled --outputdir C:\Qt

    - name: get the single precision patches
      shell: bash
      run: |
        echo "openSpaceHome is "
        echo "$openSpaceHome"
        cd "$openSpaceHome"
        git clone https://github.com/hn-88/OpenSpace-single-precision.git
        cd OpenSpace-single-precision
        cp -v ghoul-patches/* "$openSpaceHome"
        cp -v diff-files/* "$openSpaceHome"
        cd "$openSpaceHome"
        mv -v uniform_conversion.h ext/ghoul/src/opengl/uniform_conversion.h
        mv -v ghoul-src-opengl-programobject.cpp ext/ghoul/src/opengl/programobject.cpp
        python smart_patcher.py applesilicon.diffedited.txt
        # check for doubles in glsl files which might have remained
        GREP_OUTPUT=$(grep -rEn --include="*.glsl" --include="*.hglsl" --color=always "\b(double|dvec[234]?|dmat[234]?)\b" . || true)
        if [ -n "$GREP_OUTPUT" ]; then
          echo "Warning: Found double precision types in GLSL files:"
          echo "$GREP_OUTPUT"
        else
          echo "âœ“ No double precision types found in GLSL files"
        fi
        echo "Running smart_patcher for shader edits..."
        python smart_patcher.py changes-to-shadersv2.diff
    
    - name: Install vcpkg dependencies
      run: |
        git clone https://github.com/Microsoft/vcpkg.git
        cd vcpkg
        .\bootstrap-vcpkg.bat
        
        $maxAttempts = 3
        $attempt = 1
        $success = $false
        
        while (-not $success -and $attempt -le $maxAttempts) {
          Write-Host "Attempt $attempt of $maxAttempts..."
          try {
            .\vcpkg install `
              curl[ssl]:arm64-windows `
              zlib:arm64-windows `
              boost:arm64-windows `
              assimp:arm64-windows `
              gdal:arm64-windows
            $success = $true
          }
          catch {
            if ($attempt -eq $maxAttempts) { throw }
            Write-Host "Installation failed, waiting 30 seconds..."
            Start-Sleep -Seconds 30
            $attempt++
          }
        }
    
    - name: Verify vcpkg installation
      run: |
        cd vcpkg
        .\vcpkg list
        Write-Host "=== Checking arm64-windows triplet ==="
        Get-Content "triplets\arm64-windows.cmake" | Select-String -Pattern "VCPKG_CRT_LINKAGE"
    
    # --- FIX START: Remove conflicting bundled libraries ---
    - name: Remove bundled x64 dependencies
      shell: pwsh
      run: |
        Write-Host "Removing bundled dependencies to enforce vcpkg usage for ARM64..."
        
        # Remove bundled GDAL (fixes gdal_i.lib x64 conflict and link errors)
        if (Test-Path "$env:openSpaceHome/modules/globebrowsing/ext/gdal") {
             Remove-Item -Recurse -Force "$env:openSpaceHome/modules/globebrowsing/ext/gdal"
             Write-Host "Removed bundled GDAL."
        }
        
        # Remove bundled Curl/Zlib (fixes inflate redefinition and libcurl x64 conflict)
        if (Test-Path "$env:openSpaceHome/ext/curl") {
             Remove-Item -Recurse -Force "$env:openSpaceHome/ext/curl"
             Write-Host "Removed bundled Curl."
        }
        
        # Remove bundled EasyBlend (Scalable) SDK (fixes mplEasyBlendSDK.lib x64 conflict)
        # This forces SGCT to fail configuration if it tries to enable Scalable support, ensuring it stays OFF.
        Get-ChildItem -Path "$env:openSpaceHome" -Recurse -Filter "mplEasyBlendSDK.lib" | Remove-Item -Force -Verbose
    # --- FIX END ---

    - name: Configure CMake
      run: |
        cd "$env:openSpaceHome"
        cmake -S . -B build `
          -G "Visual Studio 17 2022" `
          -A ARM64 `
          -DCMAKE_TOOLCHAIN_FILE="$env:GITHUB_WORKSPACE/vcpkg/scripts/buildsystems/vcpkg.cmake" `
          -DVCPKG_TARGET_TRIPLET=arm64-windows `
          -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreadedDLL `
          -DCMAKE_PREFIX_PATH=C:/Qt/6.9.3/msvc2022_arm64 `
          -DQt6_DIR=C:/Qt/6.9.3/msvc2022_arm64/lib/cmake/Qt6 `
          -DQT_HOST_PATH=C:/Qt/6.9.3/msvc2022_64 `
          -DCMAKE_BUILD_TYPE="RelWithDebInfo" `
          -DASSIMP_BUILD_MINIZIP=1 `
          -DBUILD_TESTS=OFF `
          -DOPENSPACE_HAVE_TESTS=OFF `
          -DSGCT_BUILD_TESTS=OFF `
          -DGHOUL_HIGH_DEBUG_MODE=OFF `
          -DGHOUL_HAVE_TESTS=OFF `
          -DOPENSPACE_ENABLE_ALL_MODULES=OFF `
          -DOPENSPACE_MODULE_BASE=ON `
          -DOPENSPACE_MODULE_SPACE=ON `
          -DOPENSPACE_MODULE_GLOBEBROWSING=ON `
          -DOPENSPACE_MODULE_VIDEO=OFF `
          -DOPENSPACE_MODULE_SPOUT=OFF `
          -DSGCT_SPOUT_SUPPORT=OFF `
          -DSGCT_NDI_SUPPORT=OFF `
          -DSGCT_SCALABLE_SUPPORT=OFF `
          -DSGCT_SCALABLE=OFF `
          -DZLIB_USE_STATIC_LIBS=OFF `
          -DCURL_USE_STATIC_LIBS=OFF
          
    - name: Patch dr_mp3 for MSVC ARM64 (disable SIMD)
      if: runner.os == 'Windows' && runner.arch == 'ARM64'
      shell: pwsh
      run: |
        $file = "source/OpenSpace/modules/audio/ext/soloud/src/audiosource/wav/dr_impl.cpp"
        Write-Host "Patching $file"
        if (Test-Path $file) {
            $content = Get-Content $file -Raw
            if ($content -match "DR_MP3_NO_SIMD") {
              Write-Host "DR_MP3_NO_SIMD already present, skipping patch"
            } else {
              $patched = $content -replace `
                "#define DR_MP3_FLOAT_OUTPUT\s*\r?\n", `
                "#define DR_MP3_FLOAT_OUTPUT`r`n#define DR_MP3_NO_SIMD`r`n"
              Set-Content -Path $file -Value $patched -NoNewline
              Write-Host "Patch applied successfully"
            }
        } else {
            Write-Host "Warning: dr_impl.cpp not found. Skipping patch."
        }

    - name: Build
      run: |
        cd $env:openSpaceHome
        cmake --build ./build --config RelWithDebInfo --parallel
 
    - name: Upload Artifact only bin
      uses: actions/upload-artifact@v4
      with:
        name: OpenSpace-bindirectory-zip
        path: ${{ env.openSpaceHome }}/bin/**

    - name: Prepare and deploy
      shell: cmd
      run: |
        cd /d "%openSpaceHome%"
        
        :PostBuildCleanup
        del bin\RelWithDebInfo\*.pdb
        del bin\RelWithDebInfo\codegen.exe
        del bin\RelWithDebInfo\Qt6Svg.dll
        rmdir /S /Q bin\RelWithDebInfo\iconengines
        rmdir /S /Q bin\RelWithDebInfo\imageformats
        rmdir /S /Q bin\RelWithDebInfo\networkinformation
        robocopy bin\\RelWithDebInfo bin /E /MOV
        rmdir /S /Q bin\\RelWithDebInfo

        @echo off
        set "QtBin=${{ env.QT_DIR }}\bin"
        set "QtPlugins=${{ env.QT_DIR }}\plugins"
        set "TargetBin=${{ env.openSpaceHome }}\bin"
        
        if not exist "%TargetBin%\platforms" mkdir "%TargetBin%\platforms"
        if not exist "%TargetBin%\styles" mkdir "%TargetBin%\styles"
        if not exist "%TargetBin%\tls" mkdir "%TargetBin%\tls"
        if not exist "%TargetBin%\generic" mkdir "%TargetBin%\generic"
        
        for %%d in (dxcompiler.dll dxil.dll opengl32sw.dll) do (
          if exist "%QtBin%\%%d" copy /Y "%QtBin%\%%d" "%TargetBin%\" >nul
        )
        
        copy /Y "%QtPlugins%\platforms\qwindows.dll" "%TargetBin%\platforms\" >nul
        if exist "%QtPlugins%\styles\qmodernwindowsstyle.dll" copy /Y "%QtPlugins%\styles\qmodernwindowsstyle.dll" "%TargetBin%\styles\" >nul
        
        for %%d in (qcertonlybackend.dll qopensslbackend.dll qschannelbackend.dll) do (
          if exist "%QtPlugins%\tls\%%d" copy /Y "%QtPlugins%\tls\%%d" "%TargetBin%\tls\" >nul
        )
        
        if exist "%QtPlugins%\generic\qtuiotouchplugin.dll" copy /Y "%QtPlugins%\generic\qtuiotouchplugin.dll" "%TargetBin%\generic\" >nul
        
        curl "https://aka.ms/vs/17/release/vc_redist.x64.exe" --output vc_redist.x64.exe -L
        
        7z.exe a -tzip -mx=9 -mfb=257 -mpass=15 OpenSpace-minimal-single-precision.zip^
          bin/*^
          config/*^
          data/*^
          documentation/*^
          scripts/*^
          shaders/*^
          ACKNOWLEDGMENTS.md^
          CITATION.cff^
          CODE_OF_CONDUCT.md^
          COMMIT.md^
          CREDITS.md^
          LICENSE.md^
          openspace.cfg^
          README.md^
          vc_redist.x64.exe^
          ^
          modules/*/shaders/*^
          modules/*/scripts/*^
          modules/globebrowsing/gdal_data/*^
          modules/webgui/ext/nodejs/node.exe^
          ^
          %sync%^
          -x!documentation/.git

    - name: Upload Artifact minimal
      uses: actions/upload-artifact@v4
      with:
        name: OpenSpace-single-precision-minimal
        path: ${{ env.openSpaceHome }}/OpenSpace-minimal-single-precision.zip

    - name: Upload .zip to GitHub Release - Windows
      run: |
        $RELEASE_TAG = "daily-WIN-ZIP"
        $ZIP_FILE = "${{ env.openSpaceHome }}\OpenSpace-minimal-single-precision.zip"
        gh release view $RELEASE_TAG > $null 2>&1
        if ($LASTEXITCODE -ne 0) {
          gh release create $RELEASE_TAG -t "OpenSpace Windows Daily Build" -n "Automated daily build."
        }
        $timestamp = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd HH:mm:ss")
        gh release edit $RELEASE_TAG -n "Automated daily build of OpenSpace (updated $timestamp UTC)."
        gh release upload $RELEASE_TAG $ZIP_FILE --clobber
      env:
        GITHUB_TOKEN: ${{ secrets.PAT }}
