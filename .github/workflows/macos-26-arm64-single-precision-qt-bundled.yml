name: macos-26-arm64-single-precision-qt-bundled

on: workflow_dispatch

env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  # This yml is copied from https://github.com/hn-88/OpenSpace-AppleSiliconMac/blob/main/.github/workflows/hn-xcode16-build-hn-arm64.yml
  # and modified.
  BUILD_TYPE: Release
  OPENSPACE_VERSION: "0.21.3plus"
  THIS_REPO_PATH: "/Users/runner/work/OpenSpace-AppImage/OpenSpace-AppImage" 
  
jobs:
  build:
    # The CMake configure and build commands are platform agnostic and should work equally well on Windows or Mac.
    # You can convert this to a matrix build if you need cross-platform coverage.
    # See: https://docs.github.com/en/free-pro-team@latest/actions/learn-github-actions/managing-complex-workflows#using-a-build-matrix
    # https://github.com/actions/runner-images/blob/main/images/macos/macos-14-arm64-Readme.md
    runs-on: macos-26

    steps:
    - uses: actions/checkout@v4
    
    - name: get openspace code for a particular release
      # https://docs.openspaceproject.com/releases-v0.20/contribute/development/compiling/macos.html
      run: |
        df -h
        openSpaceHome="$HOME/source/OpenSpace"
        git clone --recursive https://github.com/OpenSpace/OpenSpace.git "$openSpaceHome"
        cd "$openSpaceHome"
        # use the main branch instead # git checkout "releases/v${OPENSPACE_VERSION}" --recurse-submodules
        # git checkout "d4d323ac491d50a4c37935b5dce8688c97353930" --recurse-submodules
        git checkout master --recurse-submodules
        mkdir build
        cd build

    - name: patches for MacOS
      run: |
        openSpaceHome="$HOME/source/OpenSpace"
        cp -v MacOS-patches/reverse_patch.py "$openSpaceHome/reverse_patch.py"
        cp -v MacOS-patches/MacOS-reverse-diff-edited.patch "$openSpaceHome/MacOS-reverse-diff-edited.patch"
        cd "$openSpaceHome"
        python3 reverse_patch.py MacOS-reverse-diff-edited.patch

    - name: smart_patcher for MacOS
      run: |
        openSpaceHome="$HOME/source/OpenSpace"
        cp -v MacOS-patches/smart_patcher.py "$openSpaceHome/smart_patcher.py"
        cp -v MacOS-patches/MacOS-patches.txt "$openSpaceHome/MacOS-patches.txt"
        cd "$openSpaceHome"
        python3 smart_patcher.py MacOS-patches.txt        
        
    - name: get the single precision patches
      # https://docs.openspaceproject.com/releases-v0.20/contribute/development/compiling/macos.html
      run: |
        openSpaceHome="$HOME/source/OpenSpace"
        cd "$openSpaceHome"
        git clone https://github.com/hn-88/OpenSpace-single-precision.git
        cd OpenSpace-single-precision
        cp -v ghoul-patches/* "$openSpaceHome"
        cp -v diff-files/* "$openSpaceHome"
        cd "$openSpaceHome"
        mv -v uniform_conversion.h ext/ghoul/src/opengl/uniform_conversion.h
        mv -v ghoul-src-opengl-programobject.cpp ext/ghoul/src/opengl/programobject.cpp
        python smart_patcher.py applesilicon.diffedited.txt
        # check for doubles in glsl files which might have remained
        GREP_OUTPUT=$(grep -rEn --include="*.glsl" --include="*.hglsl" --color=always "\b(double|dvec[234]?|dmat[234]?)\b" . || true)
        if [ -n "$GREP_OUTPUT" ]; then
          echo "Warning: Found double precision types in GLSL files:"
          echo "$GREP_OUTPUT"
        else
          echo "✓ No double precision types found in GLSL files"
        fi
        echo "Running smart_patcher for shader edits..."
        python smart_patcher.py changes-to-shadersv2.diff
        
    
    - name: Update Homebrew and Install GLM
      run: |
        brew update
        brew install glm
    
    - name: Cache Homebrew downloads 
      uses: actions/cache@v3 
      with: 
        path: | 
          ~/Library/Caches/Homebrew 
          /usr/local/Homebrew 
        key: macos26-cmake4-brew-v1
        restore-keys: | 
          macos26-cmake4-brew-
            
    - name: Install dependencies
      timeout-minutes: 30
      # https://docs.openspaceproject.com/releases-v0.20/contribute/development/compiling/ubuntu.html
      run: |
        brew install glew boost freeimage mpv vulkan-headers vulkan-loader brotli gdal qt@6 dylibbundler
        df -h

    - name: Configure CMake
      # Configure CMake in a 'build' subdirectory. `CMAKE_BUILD_TYPE` is only required if you are using a single-configuration generator such as make.
      # See https://cmake.org/cmake/help/latest/variable/CMAKE_BUILD_TYPE.html?highlight=cmake_build_type
      run: |
        openSpaceHome="$HOME/source/OpenSpace"
        cd "$openSpaceHome/build"
        # https://stackoverflow.com/questions/16700415/cmake-generate-xcode-project-from-existing-sources
        # CMAKE_PREFIX_PATH to /opt/homebrew - https://stackoverflow.com/questions/68105648/configure-cmake-to-work-with-homebrew-libraries-instead-system-provided-librarie
        cmake -G Xcode \
                  -Wno-dev \
                  -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
                  -DCMAKE_CXX_STANDARD=20 \
                  -DONLY_ACTIVE_ARCH=YES \
                  -DCMAKE_OSX_ARCHITECTURES=arm64 \
                  -DCMAKE_OSX_DEPLOYMENT_TARGET=14.0 \
                  -DCMAKE_CXX_FLAGS="-Wno-error -D_FILE_OFFSET_BITS=64" \
                  -DCMAKE_C_FLAGS="-Wno-error -D_FILE_OFFSET_BITS=64" \
                  -DCMAKE_BUILD_TYPE="Release" \
                  -DCMAKE_PREFIX_PATH=/opt/homebrew \
                  -DBUILD_TESTS=OFF \
                  -DCOMPILE_WARNING_AS_ERROR=OFF \
                  -DOPENSPACE_HAVE_TESTS=OFF \
                  -DSGCT_BUILD_TESTS=OFF \
                  -DSGCT_DEP_INCLUDE_LIBPNG=OFF \
                  -DPNG_PNG_INCLUDE_DIR=$(brew --prefix libpng)/include \
                  "$openSpaceHome"
    
    - name: Build
      # Build your program with the given configuration
      run: |
        openSpaceHome="$HOME/source/OpenSpace"
        cd "$openSpaceHome/build"
        # echo "Check to see if we have enough disk space ... " only 8 GB used out of 120+ GB
        # df -h
        cmake --build . --config ${{env.BUILD_TYPE}} -- -quiet
        df -h

    - name: run macdeployqt
      shell: bash
      run: |
        openSpaceHome="$HOME/source/OpenSpace"
        cd "$openSpaceHome"
        echo "### Bundling the QT libraries with macdeployqt"
    
        echo "/opt/homebrew/opt/qt@6/bin" >> $GITHUB_PATH
        which macdeployqt
    
        # Define variables
        APP_NAME="OpenSpace"
        APP_BUNDLE_PATH="bin/Release/$APP_NAME.app"
        
        # Verify the app bundle exists
        if [ ! -d "$APP_BUNDLE_PATH" ]; then
            echo "ERROR: App bundle not found at $APP_BUNDLE_PATH"
            ls -la bin/Release/ || ls -la bin/ || true
            exit 1
        fi
        
        APP_EXECUTABLE="$APP_BUNDLE_PATH/Contents/MacOS/OpenSpace"
        FRAMEWORKS_PATH="$APP_BUNDLE_PATH/Contents/Frameworks"
        
        # Auto-detect Qt Library Path
        QT_PATH=$(qmake -query QT_INSTALL_LIBS)
        echo "Qt Lib Path detected: $QT_PATH"
        
        echo "### 0. Initial cleanup..."
        mkdir -p "$FRAMEWORKS_PATH"
        
        # Remove all existing signatures to start fresh
        echo "Removing all existing signatures..."
        codesign --remove-signature "$APP_BUNDLE_PATH" 2>/dev/null || true
        find "$APP_BUNDLE_PATH" \( -name "*.dylib" -o -name "*.framework" \) -exec codesign --remove-signature {} \; 2>/dev/null || true
        
        echo "Current rpaths:"
        otool -l "$APP_EXECUTABLE" | grep -A 3 LC_RPATH || echo "No rpaths found"
        
        echo "### Running macdeployqt..."
        # Run macdeployqt WITHOUT signing (-codesign option not used)
        macdeployqt "$APP_BUNDLE_PATH" -verbose=1 -always-overwrite || true
        
        echo "### 1. Manually Bundling QtDBus..."
        QTDBUS_SOURCE="$QT_PATH/QtDBus.framework"
        QTDBUS_DEST="$FRAMEWORKS_PATH/QtDBus.framework"
        
        if [ -L "$QTDBUS_SOURCE" ]; then
            QTDBUS_SOURCE=$(readlink -f "$QTDBUS_SOURCE" 2>/dev/null || greadlink -f "$QTDBUS_SOURCE" 2>/dev/null || echo "$QTDBUS_SOURCE")
        fi
        
        if [ -d "$QTDBUS_SOURCE" ]; then
            if [ -e "$QTDBUS_DEST" ]; then
                rm -rf "$QTDBUS_DEST"
            fi
            
            echo "Copying QtDBus.framework..."
            cp -RL "$QTDBUS_SOURCE" "$FRAMEWORKS_PATH/"
            chmod -R u+w "$QTDBUS_DEST"
            
            # Clean up framework structure to match other Qt frameworks
            if [ -d "$QTDBUS_DEST/Versions/Current" ] && [ -d "$QTDBUS_DEST/Versions/A" ]; then
                rm -rf "$QTDBUS_DEST/Versions/Current"
            fi
            
            # Remove any top-level symlinks that might confuse signing
            find "$QTDBUS_DEST" -maxdepth 1 -type l -delete
            
            # Recreate standard Qt framework symlinks
            if [ -f "$QTDBUS_DEST/Versions/A/QtDBus" ]; then
                ln -sf Versions/A/QtDBus "$QTDBUS_DEST/QtDBus"
            fi
            if [ -d "$QTDBUS_DEST/Versions/A/Headers" ]; then
                ln -sf Versions/A/Headers "$QTDBUS_DEST/Headers"
            fi
            if [ -d "$QTDBUS_DEST/Versions/A/Resources" ]; then
                ln -sf Versions/A/Resources "$QTDBUS_DEST/Resources"
            fi
            
            QTDBUS_LIB="$QTDBUS_DEST/Versions/A/QtDBus"
            if [ -f "$QTDBUS_LIB" ]; then
                echo "Fixing QtDBus install name..."
                install_name_tool -id "@rpath/QtDBus.framework/Versions/A/QtDBus" "$QTDBUS_LIB"
                echo "QtDBus bundled successfully."
            else
                echo "ERROR: QtDBus binary not found"
                exit 1
            fi
        else
            echo "ERROR: QtDBus source not found"
            exit 1
        fi
        
        echo "### 2. Fixing rpaths..."
        CURRENT_RPATHS=$(otool -l "$APP_EXECUTABLE" | grep -A 2 LC_RPATH | grep "path" | awk '{print $2}')
        
        # Clean up rpaths
        for rpath in $CURRENT_RPATHS; do
            if [[ "$rpath" == *"@executable_path/../Frameworks"* ]]; then
                install_name_tool -delete_rpath "$rpath" "$APP_EXECUTABLE" 2>/dev/null || true
            fi
        done
        
        # Add single canonical rpath
        install_name_tool -add_rpath "@executable_path/../Frameworks/" "$APP_EXECUTABLE" 2>/dev/null || true
        
        echo "### 3. Running dylibbundler..."
        if ! command -v dylibbundler &> /dev/null; then
            brew install dylibbundler || true
        fi
        
        if command -v dylibbundler &> /dev/null; then
            # Run dylibbundler but tell it NOT to sign (we'll do that at the end)
            DYLD_LIBRARY_PATH="$FRAMEWORKS_PATH" dylibbundler \
                -b \
                -x "$APP_EXECUTABLE" \
                -d "$FRAMEWORKS_PATH" \
                -p "@executable_path/../Frameworks/" \
                --overwrite-files 2>&1 | grep -v "WARNING" | grep -v "Error : An error occurred while applying ad-hoc signature" || true
        fi
        
        echo "### 4. Cleaning up..."
        find "$APP_BUNDLE_PATH" -name "*_debug.dylib" -delete 2>/dev/null || true
        find "$APP_BUNDLE_PATH" -name "*.prl" -delete 2>/dev/null || true
        find "$APP_BUNDLE_PATH" -type d -name "Headers" -path "*/Frameworks/*" -exec rm -rf "{}" + 2>/dev/null || true
        
        echo "### 5. Remove duplicate rpaths..."
        FINAL_RPATHS=$(otool -l "$APP_EXECUTABLE" | grep -A 2 LC_RPATH | grep "path" | awk '{print $2}')
        SEEN_RPATHS=()
        
        for rpath in $FINAL_RPATHS; do
            NORMALIZED=$(echo "$rpath" | sed 's|/$||')
            DUPLICATE=false
            for seen in "${SEEN_RPATHS[@]}"; do
                if [ "$NORMALIZED" == "$seen" ]; then
                    DUPLICATE=true
                    break
                fi
            done
            
            if [ "$DUPLICATE" = true ]; then
                echo "Removing duplicate rpath: $rpath"
                install_name_tool -delete_rpath "$rpath" "$APP_EXECUTABLE" 2>/dev/null || true
            else
                SEEN_RPATHS+=("$NORMALIZED")
            fi
        done
        
        echo "### 6. Verification..."
        if [ -f "$FRAMEWORKS_PATH/QtDBus.framework/Versions/A/QtDBus" ]; then
            echo "✓ QtDBus verified"
        else
            echo "✗ QtDBus missing"
            exit 1
        fi
        
        echo "### 7. Code Signing (FINAL STEP)..."
        echo "Removing ALL signatures first..."
        # Remove all signatures from everything
        find "$APP_BUNDLE_PATH/Contents/Frameworks" -type f \( -name "*.dylib" -o -perm +111 \) -exec codesign --remove-signature {} \; 2>/dev/null || true
        find "$APP_BUNDLE_PATH/Contents/Frameworks" -type d -name "*.framework" -exec codesign --remove-signature {} \; 2>/dev/null || true
        codesign --remove-signature "$APP_EXECUTABLE" 2>/dev/null || true
        
        echo "Signing from inside out..."
        
        # Step 1: Sign all dylibs
        echo "1. Signing dylibs..."
        find "$FRAMEWORKS_PATH" -type f -name "*.dylib" | sort | while read lib; do
            codesign --force --timestamp --options runtime --sign - "$lib" || true
        done
        
        # Step 2: Sign all framework binaries (the actual library files inside Versions/A/)
        echo "2. Signing framework binaries..."
        find "$FRAMEWORKS_PATH" -type f -path "*/Versions/*/Qt*" ! -name "*.h" ! -name "*.prl" | sort | while read fwlib; do
            codesign --force --timestamp --options runtime --sign - "$fwlib" || true
        done
        
        # Step 3: Sign the frameworks themselves
        echo "3. Signing frameworks..."
        find "$FRAMEWORKS_PATH" -type d -name "*.framework" -maxdepth 1 | sort | while read fw; do
            codesign --force --timestamp --options runtime --sign - "$fw" || true
        done
        
        # Step 4: Sign the executable
        echo "4. Signing executable..."
        codesign --force --timestamp --options runtime --sign - "$APP_EXECUTABLE"
        
        # Step 5: Sign the entire bundle
        echo "5. Signing bundle..."
        codesign --force --deep --timestamp --options runtime --sign - "$APP_BUNDLE_PATH"
        
        echo "### 8. Verify signatures..."
        codesign --verify --deep --strict --verbose=2 "$APP_BUNDLE_PATH" || echo "Note: Deep verification may show warnings but bundle should still work"
        
        echo "Deployment complete!"

        
    - name: zip the app
      run: |
        cd $HOME/source/OpenSpace/bin/Release
        zip -r OpenSpaceapp.zip OpenSpace.app

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        # Artifact name
        name: OpenSpace-MacOS15-AppleSilicon-app
        # optional, default is artifact
        # A file, directory or wildcard pattern that describes what to upload
        path: /Users/runner/source/OpenSpace/bin/Release/OpenSpaceapp.zip

    - name: Prepare and deploy (MacOS)
      shell: bash
      run: |
        openSpaceHome="$HOME/source/OpenSpace"
        cd "$openSpaceHome"
        echo "### Deploying for MacOS (Release build)"

        # Define variables
        APP_NAME="OpenSpace"
        # CMake on macOS often places the .app bundle in bin/Release or just Release depending on configuration
        # Adjust this path if your build places it elsewhere (e.g., just "Release/$APP_NAME.app")
        APP_BUNDLE_PATH="bin/Release/$APP_NAME.app"
                
        # Copy documentation files to the root of the DMG/Zip (outside the app) or inside Resources.
        # Usually, License/Readme files sit next to the .app in the zip.
        # We will prepare a 'staging' folder to zip everything together cleanly.
        mkdir -p deploy_staging
        mkdir -p deploy_staging/bin
        mv "$APP_BUNDLE_PATH" deploy_staging/bin

        # Copy text files next to the App (so user sees them upon unzipping)
        cp ACKNOWLEDGMENTS.md deploy_staging/
        cp CITATION.cff deploy_staging/
        cp CODE_OF_CONDUCT.md deploy_staging/
        cp COMMIT.md deploy_staging/
        cp CREDITS.md deploy_staging/
        cp LICENSE.md deploy_staging/
        cp README.md deploy_staging/

        # Copy top-level configuration and data folders
        cp -R config deploy_staging/
        cp -R data deploy_staging/
        cp -R modules deploy_staging/
        cp -R scripts deploy_staging/
        cp -R shaders deploy_staging/
        cp openspace.cfg deploy_staging/
        
        # Copy sync folder if it exists (handling the variable %sync% from original script)
        if [ ! -z "$sync" ]; then
             cp -R $sync deploy_staging/
        fi

        # 3. Zip the result
        echo "### Create main zip file"
        cd deploy_staging
        
        # Zip the bundle and the text files. 
        # -y preserves symlinks (CRITICAL for Qt frameworks inside the .app)
        # -r recursive
        zip -r -9 -y ../OpenSpace-minimal-daily-mac-qt-bundled.zip . \
          -x "*.git*" \
          -x "*.DS_Store"

        echo "Deployment package created: OpenSpace-minimal-daily-mac.zip"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        # Artifact name
        name: OpenSpace-MacOS15-AppleSilicon-minimal
        # optional, default is artifact
        # A file, directory or wildcard pattern that describes what to upload
        path: /Users/runner/source/OpenSpace/OpenSpace-minimal-daily-mac-qt-bundled.zip

    - name: Upload .app to GitHub Release
      run: |
        RELEASE_TAG="daily-MacOS-app-single-precision"
        APP_FILE=/Users/runner/source/OpenSpace/bin/Release/OpenSpaceapp.zip
        MINZIP_FILE=/Users/runner/source/OpenSpace/OpenSpace-minimal-daily-mac-qt-bundled.zip
    
        # Create release if it doesn't exist
        gh release view "$RELEASE_TAG" >/dev/null 2>&1 || \
          gh release create "$RELEASE_TAG" -t "OpenSpace MacOS AppleSilicon Daily Build" -n "Automated daily .app build of OpenSpace."
    
        # (Optional) update title/notes each run
        gh release edit "$RELEASE_TAG" \
          -t "OpenSpace-single-precision MacOS AppleSilicon Build" \
          -n "Automated build of OpenSpace - patched to single-precision - (updated $(date '+%Y-%m-%d %H:%M:%S') UTC).  Please see documentation at https://github.com/hn-88/OpenSpace-single-precision/wiki  . You may be asked to permit running this app from an unknown publisher - please see https://github.com/hn-88/OpenSpace-AppImage/wiki/How-to-run-unsigned-apps-on-Mac . Please note all the issues at https://github.com/hn-88/OpenSpace-AppImage/issues?q=is%3Aissue%20state%3Aopen%20Mac%20build"
    
        # Upload .app asset (overwrite if exists)
        gh release upload "$RELEASE_TAG" "$MINZIP_FILE" --clobber
        
      env:
        GITHUB_TOKEN: ${{ secrets.PAT }}

      
    
