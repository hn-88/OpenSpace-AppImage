name: macos-26-arm64-single-precision-using-patcher

on: workflow_dispatch

env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  # This yml is copied from https://github.com/hn-88/OpenSpace-AppleSiliconMac/blob/main/.github/workflows/hn-xcode16-build-hn-arm64.yml
  # and modified.
  BUILD_TYPE: Release
  OPENSPACE_VERSION: "0.21.3plus"
  THIS_REPO_PATH: "/Users/runner/work/OpenSpace-AppImage/OpenSpace-AppImage" 
  
jobs:
  build:
    # The CMake configure and build commands are platform agnostic and should work equally well on Windows or Mac.
    # You can convert this to a matrix build if you need cross-platform coverage.
    # See: https://docs.github.com/en/free-pro-team@latest/actions/learn-github-actions/managing-complex-workflows#using-a-build-matrix
    # https://github.com/actions/runner-images/blob/main/images/macos/macos-14-arm64-Readme.md
    runs-on: macos-26

    steps:
    - uses: actions/checkout@v4
    
    - name: get openspace code for a particular release
      # https://docs.openspaceproject.com/releases-v0.20/contribute/development/compiling/macos.html
      run: |
        df -h
        openSpaceHome="$HOME/source/OpenSpace"
        git clone --recursive https://github.com/OpenSpace/OpenSpace.git "$openSpaceHome"
        cd "$openSpaceHome"
        # use the main branch instead # git checkout "releases/v${OPENSPACE_VERSION}" --recurse-submodules
        # git checkout "d4d323ac491d50a4c37935b5dce8688c97353930" --recurse-submodules
        git checkout master --recurse-submodules
        mkdir build
        cd build

    - name: patches for MacOS
      run: |
        openSpaceHome="$HOME/source/OpenSpace"
        cp -v MacOS-patches/reverse_patch.py "$openSpaceHome/reverse_patch.py"
        cp -v MacOS-patches/MacOS-reverse-diff-edited.patch "$openSpaceHome/MacOS-reverse-diff-edited.patch"
        cd "$openSpaceHome"
        python3 reverse_patch.py MacOS-reverse-diff-edited.patch

    - name: smart_patcher for MacOS
      run: |
        openSpaceHome="$HOME/source/OpenSpace"
        cp -v MacOS-patches/smart_patcher.py "$openSpaceHome/smart_patcher.py"
        cp -v MacOS-patches/MacOS-patches.txt "$openSpaceHome/MacOS-patches.txt"
        cd "$openSpaceHome"
        python3 smart_patcher.py MacOS-patches.txt        
        
    - name: get the single precision patches
      # https://docs.openspaceproject.com/releases-v0.20/contribute/development/compiling/macos.html
      run: |
        openSpaceHome="$HOME/source/OpenSpace"
        cd "$openSpaceHome"
        git clone https://github.com/hn-88/OpenSpace-single-precision.git
        cd OpenSpace-single-precision
        cp -v ghoul-patches/* "$openSpaceHome"
        cp -v diff-files/* "$openSpaceHome"
        cd "$openSpaceHome"
        mv -v uniform_conversion.h ext/ghoul/src/opengl/uniform_conversion.h
        mv -v ghoul-src-opengl-programobject.cpp ext/ghoul/src/opengl/programobject.cpp
        python smart_patcher.py applesilicon.diffedited.txt
        # check for doubles in glsl files which might have remained
        GREP_OUTPUT=$(grep -rEn --include="*.glsl" --include="*.hglsl" --color=always "\b(double|dvec[234]?|dmat[234]?)\b" . || true)
        if [ -n "$GREP_OUTPUT" ]; then
          echo "Warning: Found double precision types in GLSL files:"
          echo "$GREP_OUTPUT"
        else
          echo "✓ No double precision types found in GLSL files"
        fi
        
    - name: list doubles in renderable cpp files
      # https://docs.openspaceproject.com/releases-v0.20/contribute/development/compiling/macos.html
      run: |
        openSpaceHome="$HOME/source/OpenSpace"
        cd "$openSpaceHome"
        # list doubles/glm::dvec3/glm::dmat4 etc remaining in cpp files
        GREP_OUTPUT=$(grep -rEn --include="renderable*.cpp" --color=always "\b(double|dvec[234]?|dmat[234]?)\b" . || true)
        if [ -n "$GREP_OUTPUT" ]; then
          echo "Warning: Found double precision types in CPP files:"
          echo "$GREP_OUTPUT"
        else
          echo "✓ No double precision types found in CPP files"
        fi

    - name: list setUniform calls in renderable cpp files
      # https://docs.openspaceproject.com/releases-v0.20/contribute/development/compiling/macos.html
      run: |
        openSpaceHome="$HOME/source/OpenSpace"
        cd "$openSpaceHome"
        # list setUniform() in cpp files
        GREP_OUTPUT=$(grep -rEn -A 4 --include="renderable*.cpp" --color=always "setUniform" . || true)
        if [ -n "$GREP_OUTPUT" ]; then
          echo "Listing setUniform calls in renderable CPP files:"
          echo "$GREP_OUTPUT"
        else
          echo "✓ No setUniform found in these CPP files"
        fi

    - name: Fix ghoul_assert in setUniform functions
      shell: bash
      run: |
        openSpaceHome="$HOME/source/OpenSpace"
        cd $openSpaceHome
        echo "Fixing ghoul_assert in all .cpp files..."
        
        # Count files to process
        total=$(find . -type f -name "*.cpp" -exec grep -l 'ghoul_assert(location != -1, "Location must not be -1");' {} + 2>/dev/null | wc -l)
        echo "Found $total files to fix"
        
        # Use grep and sed with platform detection
        if [[ "$OSTYPE" == "darwin"* ]]; then
          # macOS (BSD sed requires empty string after -i)
          find . -type f -name "*.cpp" -exec grep -l 'ghoul_assert(location != -1, "Location must not be -1");' {} + | while read file; do
            echo "Fixing: $file"
            sed -i '' 's/ghoul_assert(location != -1, "Location must not be -1");/if (location == -1){ if (_ignoreUniformLocationError){ return; }ghoul_assert(false, "Location must not be -1");return;}/g' "$file"
          done
        else
          # Linux (GNU sed)
          find . -type f -name "*.cpp" -exec grep -l 'ghoul_assert(location != -1, "Location must not be -1");' {} + | while read file; do
            echo "Fixing: $file"
            sed -i 's/ghoul_assert(location != -1, "Location must not be -1");/if (location == -1){ if (_ignoreUniformLocationError){ return; }ghoul_assert(false, "Location must not be -1");return;}/g' "$file"
          done
        fi
        
        echo "Replacement complete!"

    - name: Update Homebrew and Install GLM
      run: |
        brew update
        brew install glm
    
    - name: Cache Homebrew downloads 
      uses: actions/cache@v3 
      with: 
        path: | 
          ~/Library/Caches/Homebrew 
          /usr/local/Homebrew 
        key: macos26-cmake4-brew-v1
        restore-keys: | 
          macos26-cmake4-brew-
            
    - name: Install dependencies
      timeout-minutes: 30
      # https://docs.openspaceproject.com/releases-v0.20/contribute/development/compiling/ubuntu.html
      run: |
        brew install glew boost freeimage mpv vulkan-headers vulkan-loader brotli gdal qt@6
        df -h

    - name: Configure CMake
      # Configure CMake in a 'build' subdirectory. `CMAKE_BUILD_TYPE` is only required if you are using a single-configuration generator such as make.
      # See https://cmake.org/cmake/help/latest/variable/CMAKE_BUILD_TYPE.html?highlight=cmake_build_type
      run: |
        openSpaceHome="$HOME/source/OpenSpace"
        cd "$openSpaceHome/build"
        # https://stackoverflow.com/questions/16700415/cmake-generate-xcode-project-from-existing-sources
        # CMAKE_PREFIX_PATH to /opt/homebrew - https://stackoverflow.com/questions/68105648/configure-cmake-to-work-with-homebrew-libraries-instead-system-provided-librarie
        cmake -G Xcode \
                  -Wno-dev \
                  -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
                  -DCMAKE_CXX_STANDARD=20 \
                  -DONLY_ACTIVE_ARCH=YES \
                  -DCMAKE_OSX_ARCHITECTURES=arm64 \
                  -DCMAKE_OSX_DEPLOYMENT_TARGET=14.0 \
                  -DCMAKE_CXX_FLAGS="-Wno-error -D_FILE_OFFSET_BITS=64" \
                  -DCMAKE_C_FLAGS="-Wno-error -D_FILE_OFFSET_BITS=64" \
                  -DCMAKE_BUILD_TYPE="Release" \
                  -DCMAKE_PREFIX_PATH=/opt/homebrew \
                  -DBUILD_TESTS=OFF \
                  -DCOMPILE_WARNING_AS_ERROR=OFF \
                  -DOPENSPACE_HAVE_TESTS=OFF \
                  -DSGCT_BUILD_TESTS=OFF \
                  -DSGCT_DEP_INCLUDE_LIBPNG=OFF \
                  -DPNG_PNG_INCLUDE_DIR=$(brew --prefix libpng)/include \
                  "$openSpaceHome"
    
    - name: Build
      # Build your program with the given configuration
      run: |
        openSpaceHome="$HOME/source/OpenSpace"
        cd "$openSpaceHome/build"
        # echo "Check to see if we have enough disk space ... " only 8 GB used out of 120+ GB
        # df -h
        cmake --build . --config ${{env.BUILD_TYPE}} -- -quiet
        df -h

    - name: run macdeployqt
      shell: bash
      run: |
        openSpaceHome="$HOME/source/OpenSpace"
        cd "$openSpaceHome"
        echo "### Bundling the QT libraries with macdeployqt"

        echo "/opt/homebrew/opt/qt@6/bin" >> $GITHUB_PATH
        which macdeployqt
        # macdeployqt -help || true

        # Define variables
        APP_NAME="OpenSpace"
        # CMake on macOS often places the .app bundle in bin/Release or just Release depending on configuration
        # Adjust this path if your build places it elsewhere (e.g., just "Release/$APP_NAME.app")
        # Define variables
        APP_NAME="OpenSpace"
        APP_BUNDLE_PATH="bin/Release/$APP_NAME.app"
        
        echo "### Verifying app bundle exists..."
        if [ ! -d "$APP_BUNDLE_PATH" ]; then
            echo "ERROR: App bundle not found at $APP_BUNDLE_PATH"
            echo "Searching for .app bundles..."
            find . -name "*.app" -type d
            exit 1
        fi
        echo "Found app bundle at: $APP_BUNDLE_PATH"
        
        echo "### Running macdeployqt..."
        if ! macdeployqt "$APP_BUNDLE_PATH" \
          -verbose=2 \
          -always-overwrite; then
            echo "ERROR: macdeployqt failed"
            exit 0
        fi
        
        echo "### Verifying Qt platform plugin..."
        if [ -d "$APP_BUNDLE_PATH/Contents/PlugIns/platforms" ]; then
            ls -la "$APP_BUNDLE_PATH/Contents/PlugIns/platforms"
        else
            echo "WARNING: platforms plugin directory not found"
        fi
        
        echo "### Cleaning debug Qt dylibs..."
        find "$APP_BUNDLE_PATH/Contents" -name "*_debug.dylib" -delete || true
        echo "Deployment complete!"


    - name: Sign macOS App with CEF (Ad-hoc)
      if: runner.os == 'macOS'
      run: |
        # Find the main .app bundle
        MAIN_APP=$(find $HOME/source/OpenSpace/bin/Release -name "OpenSpace.app" -maxdepth 1)
        
        if [ -z "$MAIN_APP" ]; then
          echo "Error: OpenSpace.app not found"
          exit 1
        fi
        
        echo "Found main app at: $MAIN_APP"
        
        # Sign in order: deepest components first
        
        # 1. Sign the CEF framework libraries and resources
        echo "Signing CEF Framework libraries..."
        find "$MAIN_APP/Contents/Frameworks/Chromium Embedded Framework.framework/Libraries" -type f -perm +111 2>/dev/null | while read file; do
          codesign --force --sign - "$file" 2>/dev/null || true
        done
        
        # 2. Sign the CEF framework itself
        echo "Signing CEF Framework..."
        codesign --force --sign - "$MAIN_APP/Contents/Frameworks/Chromium Embedded Framework.framework/Chromium Embedded Framework"
        
        # 3. Sign the CEF framework bundle
        codesign --force --sign - "$MAIN_APP/Contents/Frameworks/Chromium Embedded Framework.framework"
        
        # 4. Sign the helper apps (innermost executables first)
        echo "Signing Helper apps..."
        for helper in "OpenSpace_Helper" "OpenSpace_Helper_GPU" "OpenSpace_Helper_Renderer"; do
          HELPER_PATH="$MAIN_APP/Contents/Frameworks/${helper}.app"
          if [ -d "$HELPER_PATH" ]; then
            echo "Signing $helper..."
            # Sign the executable
            codesign --force --sign - "$HELPER_PATH/Contents/MacOS/$helper"
            # Sign the bundle
            codesign --force --sign - "$HELPER_PATH"
          fi
        done
        
        # 5. Sign Qt plugins added by macdeployqt
        echo "Signing Qt plugins..."
        if [ -d "$MAIN_APP/Contents/PlugIns" ]; then
          find "$MAIN_APP/Contents/PlugIns" -name "*.dylib" | while read lib; do
            echo "  Signing $(basename $lib)..."
            codesign --force --sign - "$lib"
          done
        fi
        
        # 6. Sign Qt frameworks added by macdeployqt
        echo "Signing Qt frameworks..."
        find "$MAIN_APP/Contents/Frameworks" -name "Qt*.framework" | while read framework; do
          # Sign the actual library inside the framework first
          FRAMEWORK_NAME=$(basename "$framework" .framework)
          if [ -f "$framework/Versions/A/$FRAMEWORK_NAME" ]; then
            echo "  Signing $FRAMEWORK_NAME library..."
            codesign --force --sign - "$framework/Versions/A/$FRAMEWORK_NAME"
          elif [ -f "$framework/$FRAMEWORK_NAME" ]; then
            echo "  Signing $FRAMEWORK_NAME library..."
            codesign --force --sign - "$framework/$FRAMEWORK_NAME"
          fi
          # Then sign the framework bundle
          echo "  Signing $FRAMEWORK_NAME framework..."
          codesign --force --sign - "$framework"
        done
        
        # 7. Sign any other frameworks or dylibs in Frameworks directory
        echo "Signing other frameworks and libraries..."
        find "$MAIN_APP/Contents/Frameworks" -name "*.dylib" -o -name "*.framework" | while read lib; do
          if [[ "$lib" != *"Chromium Embedded Framework"* ]] && [[ "$lib" != *".app"* ]] && [[ "$lib" != *"Qt"*.framework* ]]; then
            codesign --force --sign - "$lib" 2>/dev/null || true
          fi
        done
        
        # 8. Sign the main executable
        echo "Signing main executable..."
        codesign --force --sign - "$MAIN_APP/Contents/MacOS/OpenSpace"
        
        # 9. Finally, sign the main app bundle
        echo "Signing main app bundle..."
        codesign --force --sign - "$MAIN_APP"
        
        # 10. Verify the signature
        echo "Verifying signature..."
        codesign --verify --deep --strict --verbose=2 "$MAIN_APP"
        
        echo "✓ App successfully signed with ad-hoc signature"

    - name: zip the app
      run: |
        cd $HOME/source/OpenSpace/bin/Release
        zip -r OpenSpaceapp.zip OpenSpace.app

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        # Artifact name
        name: OpenSpace-MacOS15-AppleSilicon-app
        # optional, default is artifact
        # A file, directory or wildcard pattern that describes what to upload
        path: /Users/runner/source/OpenSpace/bin/Release/OpenSpaceapp.zip

    - name: Prepare and deploy (MacOS)
      shell: bash
      run: |
        openSpaceHome="$HOME/source/OpenSpace"
        cd "$openSpaceHome"
        echo "### Deploying for MacOS (Release build)"

        # Define variables
        APP_NAME="OpenSpace"
        # CMake on macOS often places the .app bundle in bin/Release or just Release depending on configuration
        # Adjust this path if your build places it elsewhere (e.g., just "Release/$APP_NAME.app")
        APP_BUNDLE_PATH="bin/Release/$APP_NAME.app"
                
        # Copy documentation files to the root of the DMG/Zip (outside the app) or inside Resources.
        # Usually, License/Readme files sit next to the .app in the zip.
        # We will prepare a 'staging' folder to zip everything together cleanly.
        mkdir -p deploy_staging
        mv "$APP_BUNDLE_PATH" deploy_staging/

        # Copy text files next to the App (so user sees them upon unzipping)
        cp ACKNOWLEDGMENTS.md deploy_staging/
        cp CITATION.cff deploy_staging/
        cp CODE_OF_CONDUCT.md deploy_staging/
        cp COMMIT.md deploy_staging/
        cp CREDITS.md deploy_staging/
        cp LICENSE.md deploy_staging/
        cp README.md deploy_staging/

        # Copy top-level configuration and data folders
        cp -R config deploy_staging/
        cp -R data deploy_staging/
        cp -R modules deploy_staging/
        cp -R scripts deploy_staging/
        cp -R shaders deploy_staging/
        cp openspace.cfg deploy_staging/
        
        # Copy sync folder if it exists (handling the variable %sync% from original script)
        if [ ! -z "$sync" ]; then
             cp -R $sync deploy_staging/
        fi

        # 3. Zip the result
        echo "### Create main zip file"
        cd deploy_staging
        
        # Zip the bundle and the text files. 
        # -y preserves symlinks (CRITICAL for Qt frameworks inside the .app)
        # -r recursive
        zip -r -9 -y ../OpenSpace-minimal-daily-mac.zip . \
          -x "*.git*" \
          -x "*.DS_Store"

        echo "Deployment package created: OpenSpace-minimal-daily-mac.zip"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        # Artifact name
        name: OpenSpace-MacOS15-AppleSilicon-minimal
        # optional, default is artifact
        # A file, directory or wildcard pattern that describes what to upload
        path: /Users/runner/source/OpenSpace/OpenSpace-minimal-daily-mac.zip

    - name: Upload .app to GitHub Release
      run: |
        RELEASE_TAG="daily-MacOS-app-single-precision"
        APP_FILE=/Users/runner/source/OpenSpace/bin/Release/OpenSpaceapp.zip
        MINZIP_FILE=/Users/runner/source/OpenSpace/OpenSpace-minimal-daily-mac.zip
    
        # Create release if it doesn't exist
        gh release view "$RELEASE_TAG" >/dev/null 2>&1 || \
          gh release create "$RELEASE_TAG" -t "OpenSpace MacOS AppleSilicon Daily Build" -n "Automated daily .app build of OpenSpace."
    
        # (Optional) update title/notes each run
        gh release edit "$RELEASE_TAG" \
          -t "OpenSpace-single-precision MacOS AppleSilicon Build" \
          -n "Automated build of OpenSpace - patched to single-precision - (updated $(date '+%Y-%m-%d %H:%M:%S') UTC).  Please download and unzip the Windows zip file from openspaceproject.com and unzip the .app file into the bin directory of the Windows version. Run using the terminal, by changing the directory with cd into the bin directory, and then running `./OpenSpace.app/Contents/MacOS/OpenSpace`. But please note the points at https://github.com/hn-88/OpenSpace-single-precision/wiki  . You may be asked to permit running this app from an unknown publisher - please see https://github.com/hn-88/OpenSpace-AppImage/wiki/How-to-run-unsigned-apps-on-Mac . Please note all the issues at https://github.com/hn-88/OpenSpace-AppImage/issues?q=is%3Aissue%20state%3Aopen%20Mac%20build"
    
        # Upload .app asset (overwrite if exists)
        gh release upload "$RELEASE_TAG" "$APP_FILE" "$MINZIP_FILE" --clobber
        
      env:
        GITHUB_TOKEN: ${{ secrets.PAT }}

      
    
